<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <link rel="stylesheet" href="/users-info-pg/globals.css" />
    <link rel="stylesheet" href="/users-info-pg/styleguide.css" />
    <link rel="stylesheet" href="/templates/css/header-footer.css" />
    <link rel="stylesheet" href="/users-info-pg/style.css" />
    <title>LearnSite - Статистика пользователей</title>
  </head>
  <body>
    <div class="screen">
      <header class="header">
        <div class="logo-group">
          <div class="logo">
            <div class="letters-group">
              <img class="logotype" src="/users-info-pg/img/лого.svg" alt="L letter" />
            </div>
          </div>
          <div class="labels">
            <h1 class="site-name">Образовательный</h1>
            <h2 class="site-subtitle">портал ГТНГ</h2>
            <span class="user-label" id="role-label">user</span>
          </div>
        </div>
        <nav class="navigation">
          <ul>
            <li><a href="/main">главная</a></li>
            <li><a href="/questions">вопросы</a></li>
            <li><a href="/all-lessons">тестирования</a></li>
            <li><a href="/lessons-content">база знаний</a></li>
            <li><a href="/users-info">пользователи</a></li>
            <li><a href="/main">новости</a></li>
          </ul>
        </nav>
        <div class="user-info">
          <span class="user-name" id="header-username">пользователь</span>
          <div class="user-icon">
            <img src="/users-info-pg/img/vector.svg" alt="User icon" />
          </div>
        </div>
      </header>
        <main class="dashboard">
          <h1 class="page-title">Статистика всех<br />пользователей</h1>
          
          <!-- Фильтры -->
          <section class="filters-section">
            <div class="filters-container">
              <select id="department-filter" class="filter-select">
                <option value="">Все отделы</option>
              </select>
              <input type="text" id="search-input" class="search-input" placeholder="Поиск по имени или логину...">
              <button id="refresh-btn" class="refresh-button">Обновить</button>
            </div>
          </section>
          
          <!-- Статистика -->
          <section class="statistics-overview">
            <div class="stats-grid">
              <div class="stat-card">
                <h3>Всего пользователей</h3>
                <span id="total-users" class="stat-number">-</span>
              </div>
              <div class="stat-card">
                <h3>Активных пользователей</h3>
                <span id="active-users" class="stat-number">-</span>
              </div>
              <div class="stat-card">
                <h3>Всего курсов</h3>
                <span id="total-courses" class="stat-number">-</span>
              </div>
              <div class="stat-card">
                <h3>Отделов</h3>
                <span id="total-departments" class="stat-number">-</span>
              </div>
            </div>
          </section>
          
          <!-- Таблица пользователей -->
          <section class="users-table-section">
            <div class="table-container">
              <table id="users-table" class="users-table">
                <thead>
                  <tr>
                    <th>Пользователь</th>
                    <th>Отдел</th>
                    <th>Должность</th>
                    <th>Курсы</th>
                    <th>Уроки</th>
                    <th>Роль</th>
                    <th>Статус</th>
                  </tr>
                </thead>
                <tbody id="users-table-body">
                  <tr>
                    <td colspan="7" class="loading">Загрузка данных...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>
          
          <!-- Кнопка экспорта -->
          <section class="export-section">
            <button class="statistics__button" id="export-btn">посмотреть таблицу excel</button>
          </section>
        </main>
        <footer class="footer">
          <div class="footer-content">
            <p class="description">платформа для обучения и тестирования</p>
            <nav class="footer-nav">
              <ul>
                <li><a href="#">о нас</a></li>
                <li><a href="#">дать обратную связь</a></li>
              </ul>
            </nav>
          </div>
        </footer>
        <div class="made-by">
            <p>Made by: Manakov Ivan</p>
        </div>
    </div>
    
    <script>
      // API endpoints
      const API_BASE = '/api';
      
      // DOM элементы
      const departmentFilter = document.getElementById('department-filter');
      const searchInput = document.getElementById('search-input');
      const refreshBtn = document.getElementById('refresh-btn');
      const exportBtn = document.getElementById('export-btn');
      const usersTableBody = document.getElementById('users-table-body');
      const headerUserName = document.getElementById('header-username');
      const headerRoleLabel = document.getElementById('role-label');
      
      let currentUser = null;
      
      // Статистика
      const totalUsersEl = document.getElementById('total-users');
      const activeUsersEl = document.getElementById('active-users');
      const totalCoursesEl = document.getElementById('total-courses');
      const totalDepartmentsEl = document.getElementById('total-departments');
      
      // Загрузка данных
      async function loadData() {
        try {
          await loadCurrentUser();
          await loadStatistics();
          await loadDepartments();
          await loadUsers();
      async function loadCurrentUser() {
        try {
          const response = await fetch(`${API_BASE}/current-user`);
          if (!response.ok) {
            currentUser = null;
            return;
          }
          currentUser = await response.json();
          if (currentUser) {
            if (headerUserName && currentUser.full_name) {
              headerUserName.textContent = currentUser.full_name;
            }
            if (headerRoleLabel) {
              const isAdmin = (currentUser.role || '').toLowerCase() === 'admin';
              headerRoleLabel.textContent = isAdmin ? 'администратор' : 'пользователь';
            }
          }
        } catch (error) {
          console.warn('Не удалось получить данные текущего пользователя:', error);
          currentUser = null;
        }
      }
          
        } catch (error) {
          console.error('Ошибка загрузки данных:', error);
          showError('Ошибка загрузки данных');
        }
      }
      
      // Загрузка статистики
      async function loadStatistics() {
        const response = await fetch(`${API_BASE}/statistics`);
        const data = await response.json();
        
        if (response.ok) {
          totalUsersEl.textContent = data.overview.total_users;
          activeUsersEl.textContent = data.overview.active_users;
          totalCoursesEl.textContent = data.overview.total_courses;
          totalDepartmentsEl.textContent = data.departments.length;
        }
      }
      
      // Загрузка отделов
      async function loadDepartments() {
        const response = await fetch(`${API_BASE}/departments`);
        const data = await response.json();
        
        if (response.ok) {
          // Очищаем и заполняем селект отделов
          departmentFilter.innerHTML = '<option value="">Все отделы</option>';
          data.departments.forEach(dept => {
            const option = document.createElement('option');
            option.value = dept;
            option.textContent = dept;
            departmentFilter.appendChild(option);
          });
        }
      }
      
      // Загрузка пользователей
      async function loadUsers() {
        const department = departmentFilter.value;
        const search = searchInput.value;
        
        let url = `${API_BASE}/users?`;
        if (department) url += `department=${encodeURIComponent(department)}&`;
        if (search) url += `search=${encodeURIComponent(search)}&`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (response.ok) {
          renderUsersTable(data.users);
        } else {
          showError('Ошибка загрузки пользователей');
        }
      }
      
      // Отображение таблицы пользователей
      function renderUsersTable(users) {
        usersTableBody.innerHTML = '';
        
        if (!Array.isArray(users) || users.length === 0) {
          usersTableBody.innerHTML = '<tr><td colspan="7" class="no-data">Пользователи не найдены</td></tr>';
          return;
        }
        
        users.forEach(user => {
          const row = document.createElement('tr');
          
          const totalCourses = Array.isArray(user.course_progress) ? user.course_progress.length : 0;
          const completedCourses = Array.isArray(user.course_progress)
            ? user.course_progress.filter(cp => cp.is_completed).length
            : 0;
          const totalLessons = Array.isArray(user.course_progress)
            ? user.course_progress.reduce((sum, cp) => sum + (cp.lessons_completed || 0), 0)
            : 0;
          
          const department = user.department || 'Не указан';
          const position = user.position || 'Не указана';
          const fullName = user.full_name || '—';
          const username = user.username ? `@${user.username}` : '—';
          
          const normalizedRole = (user.role || 'user').toLowerCase();
          const roleLabel = normalizedRole === 'admin' ? 'Администратор' : 'Пользователь';
          const roleClass = normalizedRole === 'admin' ? 'role-admin' : 'role-user';
          
          row.innerHTML = `
            <td>
              <div class="user-info">
                <strong>${fullName}</strong>
                <small>${username}</small>
              </div>
            </td>
            <td>${department}</td>
            <td>${position}</td>
            <td>
              <div class="courses-info">
                <span class="courses-count">${completedCourses}/${totalCourses}</span>
                <small>курсов завершено</small>
              </div>
            </td>
            <td>
              <div class="progress-info">
                <span class="lessons-count">${totalLessons}</span>
                <small>уроков пройдено</small>
              </div>
            </td>
            <td>
              <span class="role-badge ${roleClass}">${roleLabel}</span>
            </td>
            <td>
              <span class="status-badge ${user.is_active ? 'active' : 'inactive'}">
                ${user.is_active ? 'Активен' : 'Неактивен'}
              </span>
            </td>
          `;
          
          row.addEventListener('click', () => {
            showUserDetails(user.id);
          });
          
          usersTableBody.appendChild(row);
        });
      }
      
      // Показать детали пользователя
      async function showUserDetails(userId) {
        try {
          const response = await fetch(`${API_BASE}/users/${userId}/progress`);
          const data = await response.json();
          
          if (response.ok) {
            // Создаем модальное окно с детальной информацией
            showUserModal(data);
          }
        } catch (error) {
          console.error('Ошибка загрузки деталей пользователя:', error);
        }
      }
      
      // Показать модальное окно с деталями пользователя
      function showUserModal(userData) {
        const modal = document.createElement('div');
        modal.className = 'user-modal';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h2>${userData.full_name}</h2>
              <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
              <div class="user-details">
                <p><strong>Логин:</strong> ${userData.username}</p>
                <p><strong>Отдел:</strong> ${userData.department}</p>
              </div>
              
              <div class="progress-summary">
                <h3>Общая статистика</h3>
                <div class="summary-stats">
                  <div class="summary-stat">
                    <span class="stat-value">${userData.summary.total_courses}</span>
                    <span class="stat-label">Всего курсов</span>
                  </div>
                  <div class="summary-stat">
                    <span class="stat-value">${userData.summary.completed_courses}</span>
                    <span class="stat-label">Завершено</span>
                  </div>
                  <div class="summary-stat">
                    <span class="stat-value">${userData.summary.total_lessons_completed}</span>
                    <span class="stat-label">Уроков пройдено</span>
                  </div>
                  <div class="summary-stat">
                    <span class="stat-value">${userData.summary.average_progress}%</span>
                    <span class="stat-label">Средний прогресс</span>
                  </div>
                </div>
              </div>
              
              <div class="courses-progress">
                <h3>Прогресс по курсам</h3>
                <div class="courses-list">
                  ${userData.progress.map(course => `
                    <div class="course-item">
                      <div class="course-header">
                        <h4>${course.course_title}</h4>
                        <span class="course-progress">${course.progress_percentage}%</span>
                      </div>
                      <div class="course-details">
                        <p>${course.lessons_completed}/${course.total_lessons} уроков</p>
                        <div class="progress-bar">
                          <div class="progress-fill" style="width: ${course.progress_percentage}%"></div>
                        </div>
                        <p class="course-status ${course.is_completed ? 'completed' : 'in-progress'}">
                          ${course.is_completed ? 'Завершен' : 'В процессе'}
                        </p>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Обработчики событий
        modal.querySelector('.close-modal').addEventListener('click', () => {
          document.body.removeChild(modal);
        });
        
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            document.body.removeChild(modal);
          }
        });
      }
      
      // Показать ошибку
      function showError(message) {
        usersTableBody.innerHTML = `<tr><td colspan="7" class="error">${message}</td></tr>`;
      }
      
      // Обработчики событий
      departmentFilter.addEventListener('change', loadUsers);
      searchInput.addEventListener('input', debounce(loadUsers, 300));
      refreshBtn.addEventListener('click', loadData);
      
      // Экспорт в Excel (заглушка)
      exportBtn.addEventListener('click', () => {
        alert('Функция экспорта в Excel будет реализована в следующей версии');
      });
      
      // Функция debounce для поиска
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }
      
      // Загружаем данные при загрузке страницы
      document.addEventListener('DOMContentLoaded', loadData);
    </script>
  </body>
</html>
