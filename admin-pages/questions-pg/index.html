<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <title>LearnSite - –í–æ–ø—Ä–æ—Å—ã</title>
    <link rel="stylesheet" href="/questions-pg/globals.css" />
    <link rel="stylesheet" href="/questions-pg/styleguide.css" />
    <link rel="stylesheet" href="/templates/css/header-footer.css" />
    <link rel="stylesheet" href="/questions-pg/style.css" />
  </head>
  <body>
    <div class="screen">
      <main class="main-content">
        <h1 class="page-title">–í–æ–ø—Ä–æ—Å—ã</h1>
        <div class="qa-toolbar">
          <div class="pill-filter">
            <button class="pill active" data-filter="all">–í—Å–µ</button>
            <button class="pill" data-filter="unanswered">–ë–µ–∑ –æ—Ç–≤–µ—Ç–∞</button>
            <button class="pill" data-filter="resolved">–° –æ—Ç–≤–µ—Ç–æ–º</button>
              </div>
          <input class="search-input" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é..." />
              </div>
        <section id="questions-list" class="courses-grid"></section>
      </main>
    </div>
  <script>
    (function () {
      function el(tag, cls){ var n=document.createElement(tag); if(cls) n.className=cls; return n; }
      function autoResize(el){ el.style.height='auto'; el.style.height=el.scrollHeight+'px'; }

      var state = { filter: 'all', search: '' };

      function renderQuestionCard(q){
        var card = el('article','course-card');
        var content = el('div','card-content');
        card.appendChild(content);

        var header = el('div','card-header');
        var title = el('h3','card-title');
        title.textContent = q.title + ' ‚Äî ' + (q.author_full_name || q.author_username || '');
        header.appendChild(title);
        content.appendChild(header);

        var main = el('div','card-main');
        var h2 = el('h2','main-p'); h2.textContent = '–ó–∞–≥–æ–ª–æ–≤–æ–∫';
        var p = el('p','content-p'); p.textContent = q.body;
        main.appendChild(h2); main.appendChild(p);
        content.appendChild(main);

        if (q.tags && q.tags.length){
          var tagsC = el('div','tags-container');
          var lbl = el('span','tags-label'); lbl.textContent='—Ç–µ–≥–∏:';
          var list = el('div','tags-list');
          q.tags.forEach(function(t){ var s=el('span','tag'); s.textContent=t; list.appendChild(s); });
          tagsC.appendChild(lbl); tagsC.appendChild(list);
          content.appendChild(tagsC);
        }

        var answersList = el('div','answers-list');
        content.appendChild(answersList);

        // –û—Ç–≤–µ—Ç –∞–¥–º–∏–Ω–∞
        var titleAns = el('h3','card-title-answer'); titleAns.textContent='–û—Ç–≤–µ—Ç–∏—Ç—å';
        content.appendChild(titleAns);

        var notes = el('div','notes-wrapper');
        var ta = el('textarea','notes-input'); ta.placeholder='–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç...';
        var file = el('input','file-input'); file.type='file'; file.multiple=true;
        file.id = 'file-input-'+q.id;
        var actions = el('div','notes-actions');
        var attach = el('label','attach-btn'); attach.htmlFor=file.id; attach.title='–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª'; attach.textContent='üìé';
        var send = el('button','send-btn'); send.type='button'; send.title='–û—Ç–ø—Ä–∞–≤–∏—Ç—å'; send.textContent='‚û§';
        actions.appendChild(attach); actions.appendChild(send);
        notes.appendChild(ta); notes.appendChild(file); notes.appendChild(actions);
        var filesPreview = el('div','attached-files'); filesPreview.setAttribute('aria-live','polite');
        content.appendChild(notes); content.appendChild(filesPreview);

        function loadAnswers(){
          fetch('/api/questions/'+q.id+'/answers').then(r=>r.json()).then(function(d){
            answersList.innerHTML='';
            (d.answers||[]).forEach(function(a){
              var item = el('div','answer-item');
              var t = el('div','answer-text');
              t.textContent = (a.author_full_name||a.author_username||'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä')+': '+a.body;
              item.appendChild(t);
              // attachments
              (a.attachments||[]).forEach(function(att){
                var chip = el('div','attached-file-chip');
                var link = el('a'); link.href=att.url; link.textContent=att.original_filename; link.download=att.original_filename; chip.appendChild(link);
                item.appendChild(chip);
              });
              answersList.appendChild(item);
            });
          });
        }
        loadAnswers();

        file.addEventListener('change', function(){
          if (!file._queue) file._queue=[];
          Array.prototype.forEach.call(file.files, function(f){ file._queue.push(f); var chip=el('div','attached-file-chip'); var a=el('a'); a.href=URL.createObjectURL(f); a.textContent=f.name; a.download=f.name; chip.appendChild(a); filesPreview.appendChild(chip); });
          file.value='';
        });

        send.addEventListener('click', function(){
          var body=(ta.value||'').trim(); if(!body) return;
          fetch('/api/questions/'+q.id+'/answers', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({body})})
            .then(function(r){ if(!r.ok) throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞'); return r.json(); })
            .then(function(res){
              var created = res && res.answer; if (created && file._queue && file._queue.length){
                var uploads = file._queue.map(function(f){ var fd=new FormData(); fd.append('file', f); return fetch('/answers/'+created.id+'/attachments', {method:'POST', body: fd}); });
                Promise.allSettled(uploads).then(loadAnswers);
              } else { loadAnswers(); }
              ta.value=''; autoResize(ta); filesPreview.innerHTML=''; file._queue=[];
            }).catch(console.error);
        });

        autoResize(ta);
        return card;
      }

      function loadQuestions(){
        var params = new URLSearchParams();
        if (state.search) params.set('search', state.search);
        if (state.filter==='unanswered') params.set('resolved','false');
        if (state.filter==='resolved') params.set('resolved','true');
        return fetch('/api/questions?'+params.toString())
          .then(r=>r.json())
          .then(function(d){
            var list = document.getElementById('questions-list');
            list.innerHTML='';
            (d.questions||[]).forEach(function(q){ list.appendChild(renderQuestionCard(q)); });
          });
      }

      document.querySelector('.search-input').addEventListener('input', function(e){ state.search = e.target.value.trim(); loadQuestions(); });
      document.querySelectorAll('.pill').forEach(function(btn){ btn.addEventListener('click', function(){ document.querySelectorAll('.pill').forEach(function(b){ b.classList.remove('active'); }); btn.classList.add('active'); state.filter = btn.dataset.filter; loadQuestions(); }); });

      loadQuestions();
    })();
  </script>
  </body>
</html>

