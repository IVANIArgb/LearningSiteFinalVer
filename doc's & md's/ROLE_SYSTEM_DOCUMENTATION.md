# Система ролевой маршрутизации

## Обзор

Система автоматически определяет роль пользователя и показывает соответствующие шаблоны:
- **Админы** видят шаблоны из папки `admin-pges`
- **Обычные пользователи** видят шаблоны из папки `user-ges`

## Как это работает

### 1. Определение роли пользователя

Система определяет роль пользователя на основе имени пользователя из Windows Authentication:

**Админы** (показываются шаблоны из `admin-pges`):
- `admin`
- `administrator` 
- `root`
- `manager`
- `админ`
- `администратор`
- `руководитель`

**Обычные пользователи** (показываются шаблоны из `user-ges`):
- Все остальные имена пользователей

### 2. Структура папок

```
Learning Site Final/
├── admin-pges/          # Шаблоны для админов
│   ├── main-pg/
│   ├── all-courses-pg/
│   ├── questions-pg/
│   └── ...
├── user-ges/            # Шаблоны для обычных пользователей
│   ├── main-pg/
│   ├── all-courses-pg/
│   ├── questions-pg/
│   └── ...
└── admin-pges/backend/  # Backend код
```

### 3. Автоматическая маршрутизация

При заходе на любую страницу система:
1. Получает имя пользователя через Windows Authentication
2. Определяет роль (admin/user)
3. Выбирает соответствующую папку с шаблонами
4. Показывает нужный шаблон

## Настройка

### Добавление новых админов

Чтобы добавить новых админов, отредактируйте файл `backend/auth.py`:

```python
def _determine_user_role(self, username: str) -> str:
    admin_users = [
        'admin', 'administrator', 'root', 'manager',
        'админ', 'администратор', 'руководитель',
        'ваш_новый_админ'  # Добавьте сюда
    ]
    # ... остальной код
```

### Изменение логики определения ролей

Вы можете изменить логику в методе `_determine_user_role()` для:
- Проверки групп Active Directory
- Проверки домена пользователя
- Интеграции с базой данных ролей

## Тестирование

### Ручное тестирование

1. Запустите сервер:
   ```bash
   cd admin-pges
   python run.py
   ```

2. Откройте браузер: `http://127.0.0.1:5000`

3. Для тестирования админского интерфейса:
   - Установите заголовок `X-Remote-User: admin`
   - Или используйте имя пользователя `admin`

4. Для тестирования пользовательского интерфейса:
   - Используйте любое другое имя пользователя

### Автоматическое тестирование

Запустите тестовый скрипт:
```bash
cd admin-pges
python test_role_system.py
```

### Отладка аутентификации

Перейдите на `/debug/auth` для просмотра информации об аутентификации (только в режиме отладки).

## API

### Получение информации о текущем пользователе

```http
GET /api/user
```

Ответ:
```json
{
  "username": "admin",
  "role": "admin",
  "full_name": "Admin",
  "domain": null,
  "ip_address": "127.0.0.1",
  "auth_method": "windows_auth"
}
```

### Отладочная информация

```http
GET /debug/auth
```

Показывает детальную информацию о заголовках аутентификации и конфигурации.

## Конфигурация

### Переменные окружения

- `WINDOWS_AUTH_ENABLED=true` - включить Windows Authentication
- `WINDOWS_AUTH_DEBUG=false` - включить отладочный режим
- `FLASK_ENV=development` - режим разработки

### Настройки в config.py

```python
# Папки с шаблонами
ADMIN_TEMPLATE_DIR = "admin-pges"
USER_TEMPLATE_DIR = "user-ges"

# Разрешенные страницы
ALLOWED_PAGE_DIRS = [
    "main-pg",
    "all-categories-pg", 
    "all-courses-pg",
    "all-lessons-pg",
    "lessons-content-pg",
    "questions-pg",
    "users-info-pg",
]
```

## Безопасность

- Система использует Windows Authentication для определения пользователя
- Роли определяются на сервере, не на клиенте
- Все шаблоны проверяются на существование перед отображением
- Пути к файлам нормализуются для предотвращения directory traversal

## Поддержка

При возникновении проблем:

1. Проверьте логи в `backend/logs/app.log`
2. Используйте `/debug/auth` для диагностики
3. Убедитесь, что папки `admin-pges` и `user-ges` существуют
4. Проверьте права доступа к файлам шаблонов
